<h1>Stock Trading</h1>

<div>
  <h2>Current Price: <span id="current-price">$<%= number_with_precision(@current_price, precision: 2) %></span></h2>
</div>

<div id="bad-network">
  Disconnected from server. Attempting to reconnect...
</div>

<div id="historical-prices">
  <h3>Last 30 Seconds</h3>
  <canvas id="price-chart"></canvas>
</div>

<div id="trading-actions">
  <!-------------------------------------------------------------->
  <!-- <%= button_to 'Buy', buy_quotes_path, method: :post %>   -->
  <!-- <%= button_to 'Sell', sell_quotes_path, method: :post %> -->
  <!-------------------------------------------------------------->
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const price_data = <%= raw @historical_prices.to_json %>.reverse();
  const ctx = document.getElementById('price-chart').getContext('2d');
  let chart = null;

  function updateChart(newData) {
    if(typeof newData !== 'undefined') {
      price_data.push(newData);
      price_data.shift();
      document.getElementById('current-price').textContent = `$${newData[0]}`;
    }
    if(chart) {
      chart.data.labels = price_data.map(d => new Date(d[1]).toLocaleTimeString());
      chart.data.datasets[0].data = price_data.map(d => d[0]);
      chart.update();
    } else {
      renderChart();
    }
  }
  
  function renderChart(newData) {
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: price_data.map(d => new Date(d[1]).toLocaleTimeString()),
        datasets: [{
          label: 'Stock Price',
          data: price_data.map(d => d[0]),
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }
  document.addEventListener('DOMContentLoaded', renderChart);
  // @HACK: Probably a better event to listen to here
  document.addEventListener('turbo:load', renderChart);
</script>
